const isNotebook="Notebook"===$("#environment").val();class Button{constructor(e,t){this.buttonId=e,this.functionName=t}}function studio_load_grader_test_cases(e){isNotebook?notebook_grader_load_all_tests(e):multiLangLoadAllTests(e)}function activeSortableMode(){const e=getContainerDiv();Sortable.create(e,{group:"test-cases",animation:150,easing:"cubic-bezier(0.895, 0.03, 0.685, 0.22)",handle:".item-cursor-move",chosenClass:"active",onEnd:e=>{updateAllIds(e.oldIndex,e.newIndex)}})}function getContainerDiv(){return isNotebook?$("#notebook_grader_tests_container")[0]:$("#grader_test_cases_container")[0]}function updateAllIds(e,t){e-t<0?updateIdsLowestToHighest(e,t):updateIdsHighestToLowest(e,t)}function updateIdsHighestToLowest(e,t){updateTestInternalIds(e,"AUX");for(let o=e-1;o>=t;o--)updateTestInternalIds(o,o+1);updateTestInternalIds("AUX",t)}function updateIdsLowestToHighest(e,t){updateTestInternalIds(e,"AUX");for(let o=e+1;o<=t;o++)updateTestInternalIds(o,o-1);updateTestInternalIds("AUX",t)}function updateTestInternalIds(e,t){updateTestRowId(e,t),updateTestParametersId(e,t),updateButtonsId(e,t),isNotebook&&updateNotebookTestCasesContainer(e,t)}function updateTestRowId(e,t){const o=getBaseId(e),_=getBaseId(t);$(`#${o}`).attr("id",_)}function updateTestParametersId(e,t){const o=getParametersArray(),_=`${getIdPrefix()}[${t}]`,s=getBaseId(e),n=getBaseId(t);$.each(o,(e,t)=>{let o=$(`#${s}_${t}`);o.attr("id",`${n}_${t}`),o.attr("name",`${_}[${t}]`)})}function updateButtonsId(e,t){const o=getBaseId(e),_=getBaseId(t),s=getButtonsInfo();$.each(s,(e,s)=>{let n=s.buttonId,a=s.functionName,r=$(`#${o}_${n}`);r.attr("id",`${_}_${n}`),r.attr("onclick",`${a}(${t})`)})}function getBaseId(e){return`${getIdPrefix()}_${e}`}function getIdPrefix(){return isNotebook?"notebook_grader_test":"grader_test_cases"}function getParametersArray(){return isNotebook?notebookTestCaseParameterIds:multiLangTestCaseParameters}function getButtonsInfo(){return isNotebook?notebookButtons:multiLangButtons}function updateNotebookTestCasesContainer(e,t){const o=getCurrentNumTestCases(e),_=getBaseId(e),s=getBaseId(t),n=`${getIdPrefix()}[${t}]`;$(`#${_}_cases_container`).attr("id",`${s}_cases_container`);for(let e=0;e<o;e++)$(`#${_}_cases_${e}`).attr("id",`${s}_cases_${e}`),$.each(notebookModalParameterIds,(t,o)=>{let a=$(`#${_}_cases_${e}_${o}`);a.attr("id",`${s}_cases_${e}_${o}`),a.attr("name",`${n}[cases][${e}][${o}]`)}),$.each(notebookModalButtonIds,(o,n)=>{let a=n.buttonId,r=n.functionName,d=$(`#${_}_cases_${e}_${a}`);d.attr("onclick",`${r}(${t},${e})`),d.attr("id",`${s}_cases_${e}_${a}`)})}function toggleSelectionTestsCases(){const e=getDiffCheckboxButton(),t=!e[0].checked;e.prop("checked",t),setAllDiffShowCheckboxValue(t)}function setAllDiffShowCheckboxValue(e){const t=getCurrentNumTests();for(let o=0;o<t;o++)$(`#${getIdPrefix()}_${o}_${getDiffIdSuffix()}`).prop("checked",e)}function isAllShowDiffChecked(){const e=$(`[id$='${getDiffIdSuffix()}']:checked`).length;return getCurrentNumTests()===e}function updateMainShowDiffsCheckbox(){const e=getDiffCheckboxButton();isAllShowDiffChecked()?e.prop("checked",!0):e.prop("checked",!1)}function getDiffCheckboxButton(){return isNotebook?$("#notebookToggleSelectTestCases"):$("#toggle_select_test_cases")}function getDiffIdSuffix(){return isNotebook?"show_debug_info":"diff_shown"}function getCurrentNumTests(){return isNotebook?notebook_grader_tests_sequence:grader_test_cases_count}$("[href='#tab_grader']").click(function(){updateMainShowDiffsCheckbox()});const multiLangTestCaseParameters=["input_file","output_file","weight","custom_feedback","diff_shown"],multiLangButtons=[new Button("delete_btn","studio_remove_test_case")];let grader_test_cases_count=0,test_cases_input=[];function studio_add_test_case_from_form(){studio_add_test_case({input_file:$("#grader_test_case_in").val(),output_file:$("#grader_test_case_out").val()}),updateMainShowDiffsCheckbox()}function studio_add_test_case(e){e=$.extend({input_file:null,output_file:null,weight:1,custom_feedback:"",diff_shown:!1},e);const t=grader_test_cases_count,o=e.input_file,_=e.output_file;if(!o||!_)return;const s=$("#test_case_template").html().replace(/TID/g,t),n=$(s);insertDataContent(n,e),grader_test_cases_count++,test_cases_input.push(o),hideOrShowHeader(),$("#grader_test_cases_container").append(n)}function insertDataContent(e,t){const o=e.attr("id"),_=multiLangTestCaseParameters.slice(0,-1);$.each(_,(_,s)=>{e.find(`#${o}_${s}`).val(t[s])}),e.find(`#${o}_diff_shown`).prop("checked",t.diff_shown)}function getIdNum(e){const t="grader_test_cases_".length;return e.substr(t)}function multiLangLoadAllTests(e){$.each(e,function(e,t){studio_add_test_case(t)})}function studio_remove_test_case(e){const t=`grader_test_cases_${e}`,o=$(`#${t}_input_file`).val(),_=test_cases_input.indexOf(o);$(`#${t}`).remove(),correctIds(e),grader_test_cases_count--,hideOrShowHeader(),test_cases_input.splice(_,1)}function hideOrShowHeader(){0===grader_test_cases_count?$("#grader_test_cases_header").hide():$("#grader_test_cases_header").show()}function correctIds(e){for(let t=e+1;t<grader_test_cases_count;t++)updateTestInternalIds(t,t-1)}function studio_update_grader_problems(){let e=$("#accordion"),t=[];$.each(e.children(),function(e,o){let _=o.id;if(!_.startsWith("subproblem_well_"))throw new Error("Unable to process problem well: "+_);let s=_.substring("subproblem_well_".length),n=$(o).find("[name='problem["+s+"][type]']").val();t.push({id:s,type:n})});const o=$("#grader_problem_id");let _=o.val();o.empty();const s=["code_multiple_languages","code_file_multiple_languages","notebook_file"];$.each(t,function(e,t){-1!==s.indexOf(t.type)&&(o.append($("<option>",{value:t.id,text:t.id})),_=t.id)}),o.val(_)}function studio_set_initial_problem(e){const t=$("#grader_problem_id");let o=e;$("#generate_grader").is(":checked")&&e&&(o=e,t.append($("<option>",{value:e,text:e}))),t.val(o)}function studio_update_grader_files(){"Notebook"!==$("#environment").val()&&$.get("/api/grader_generator/test_file_api",{course_id:courseId,task_id:taskId},function(e){const t=$("#grader_test_case_in"),o=$("#grader_test_case_out"),_=$("#testbench_file_name"),s=$("#hdl_expected_output");t.empty(),o.empty(),_.empty(),s.empty(),$.each(e,function(e,n){if(n.is_directory)return;if("run"===n.complete_name)return;let a=$("<option>",{value:n.complete_name,text:n.complete_name});t.append(a),o.append(a.clone()),_.append(a.clone()),s.append(a.clone())})},"json")}function studio_update_container_name(){const e=$("#environment").val(),t=$(".grader_form"),o=$("#tab_grader");o.find("div.form-group")[2].style.display="block",o.find("div.form-group")[3].style.display="block";for(let e=0;e<t.length;e++)t[e].style.display="none";try{switch(e){case"Notebook":$("#notebook_grader_form")[0].style.display="block",o.find("div.form-group")[2].style.display="none",o.find("div.form-group")[3].style.display="none";break;case"HDL":$("#hdl_grader_form")[0].style.display="block";break;case"multiple_languages":case"Data Science":$("#multilang_grader_form")[0].style.display="block"}}catch{}}function read_files_and_match(){const e=$("#environment").val();"Notebook"!==e&&"HDL"!==e&&$.get("/api/grader_generator/test_file_api",{course_id:courseId,task_id:taskId},function(e){$.each(e,function(t,o){if(o.is_directory)return;let _={};const s=o.name.split("."),n=o.complete_name.split("."),a=s.splice(0,s.length-1).join("."),r=n.splice(0,n.length-1).join(".")+".out";if(!test_cases_input.includes(o.name)&&"in"===s[s.length-1]){const t={level:o.level,complete_name:r,name:a+".out",is_directory:!1};for(let s=0;s<e.length;s++){const n=e[s];n.complete_name===t.complete_name&&n.is_directory===t.is_directory&&studio_add_test_case(_={input_file:o.complete_name,output_file:t.complete_name})}}})},"json")}function remove_all_test_cases(){for(let e=0;e<grader_test_cases_count;e++)studio_remove_test_case(e);grader_test_cases_count=0}function expand_text_area(e,t=6){e.rows=t}function compress_text_area(e,t=2){e.rows=t}const notebookTestCaseParameterIds=["name","weight","setup_code","custom_feedback","show_debug_info"],notebookButtons=[new Button("edit_btn","notebook_grader_on_edit_test"),new Button("delete_btn","notebook_grader_remove_test")],notebookModalParameterIds=["code","expected_output"],notebookModalButtonIds=[new Button("delete_btn","notebook_grader_remove_test_case")];let notebook_grader_tests_sequence=0,editing_test_id=null;const modal_element=$("#notebook_grader_test_form_modal");function toggle_test_case_form_alert(e,t){const o=$("#test_case_alert");o.text(t),e?o.show():o.hide()}function getContainerNumTestCases(e){return $(`#${e} div[class="row test-case"]`).length}function getCurrentNumTestCases(e){return getContainerNumTestCases(`notebook_grader_test_${e}_cases_container`)}function getNumTestCasesOnModal(){return getContainerNumTestCases("notebook_grader_test_cases_container")}function notebook_grader_add_test_case_from_form(){const e=getNumTestCasesOnModal(),t=notebook_grader_create_test_case({code:$("#notebook_grader_test_case_code").val(),expected_output:$("#notebook_grader_test_case_expected_output").val()},e);t&&(1===e&&$("#notebook_grader_test_cases_header").show(),$("#notebook_grader_test_cases_container").append(t),codeEditors.notebook_grader_test_case_code.getDoc().setValue(""),$("#notebook_grader_test_case_expected_output").val(""),$(`#${t.attr("id")} .notebook_code`).each(function(e,t){registerCodeEditor(t,$(t).attr("data-x-language"),$(t).attr("data-x-lines"))}))}function notebook_grader_create_test_case(e,t){if(!(e=$.extend({code:null,expected_output:null},e)).code||!e.expected_output){toggle_test_case_form_alert(!0,"Please complete all the fields to add a test case."),setTimeout(()=>{toggle_test_case_form_alert(!1,"")},6e4)}const o=null!==editing_test_id?editing_test_id:notebook_grader_tests_sequence,_=t,s=e.code,n=e.expected_output;if(s&&n)return _notebook_grader_get_test_case_element(o,_,s,n)}function notebook_grader_remove_test_case(e,t){const o=_notebook_grader_shift_test_cases(e,t,"notebook_grader_test_cases_container"),_=$("#notebook_grader_test_cases_container");_.html(""),$.each(o,(e,t)=>{_.append(t);const o=$(`#${t.attr("id")}_code`)[0];registerCodeEditor(o,$(o).attr("data-x-language"),$(o).attr("data-x-lines"))}),0===getNumTestCasesOnModal()&&$("#notebook_grader_test_cases_header").hide()}function _notebook_grader_shift_test_cases(e,t){const o=getNumTestCasesOnModal(),_=[];let s=0;for(let n=0;n<o;n++){if(n===t)continue;const o=_notebook_grader_get_test_case_element(e,s,$(`#notebook_grader_test_${e}_cases_${n}_code`).val(),$(`#notebook_grader_test_${e}_cases_${n}_expected_output`).val());_.push(o),s++}return _}function _notebook_grader_get_test_case_element(e,t,o,_){const s=$("#notebook_test_case_template").html().replace(/TID/g,e).replace(/CID/g,t).replace(/case_label/g,t+1),n=$(s);return n.find(`#notebook_grader_test_${e}_cases_${t}_code`).text(o),n.find(`#notebook_grader_test_${e}_cases_${t}_expected_output`).text(_),n}function _notebook_grader_get_test_element(e,t,o){const _=$("#notebook_grader_test_template").html().replace(/TID/g,e),s=t.name,n=t.weight,a=t.setup_code,r=t.show_debug_info,d=t.custom_feedback,c=$(_);return c.find(`#notebook_grader_test_${e}_name`).val(s),c.find(`#notebook_grader_test_${e}_weight`).val(n),c.find(`#notebook_grader_test_${e}_custom_feedback`).text(d),c.find(`#notebook_grader_test_${e}_setup_code`).text(a),c.find(`#notebook_grader_test_${e}_show_debug_info`).prop("checked",r),$.each(o,(t,o)=>{_deleteCodeMirror(o),c.find(`#notebook_grader_test_${e}_cases_container`).append(o)}),c}function _notebook_grader_get_test_cases_from_container(e,t){const o=getContainerNumTestCases(t),_=$(`#${t}`),s=[];for(let t=0;t<o;t++){const o=_.find(`#notebook_grader_test_${e}_cases_${t}`);s.push(o)}return s}function notebook_grader_add_test_from_form(){const e=_notebook_grader_get_test_cases_from_container(notebook_grader_tests_sequence,"notebook_grader_test_cases_container"),t=notebook_grader_create_test({name:$("#notebook_grader_test_name").val(),weight:$("#notebook_grader_test_weight").val(),custom_feedback:$("#notebook_grader_test_custom_feedback").val(),setup_code:$("#notebook_grader_test_setup_code").val()},e);t&&(1===notebook_grader_tests_sequence&&$("#notebook_grader_tests_header").show(),$("#notebook_grader_tests_container").append(t),modal_element.modal("hide"))}function notebook_grader_create_test(e,t){if(!(e=$.extend({name:"test",weight:1,show_debug_info:!1,setup_code:"",custom_feedback:""},e)).name||!e.weight){return toggle_test_case_form_alert(!0,"Please complete all mandatory fields."),void setTimeout(()=>{toggle_test_case_form_alert(!1,"")},6e4)}const o=notebook_grader_tests_sequence,_=e.name,s=e.weight;if(_&&s&&t.length)return notebook_grader_tests_sequence++,_notebook_grader_get_test_element(o,e,t)}function notebook_grader_load_all_tests(e){$.each(e,function(e,t){const o=[];let _=0;$.each(t.cases,(e,t)=>{const s=notebook_grader_create_test_case(t,_);o.push(s),_++});const s=notebook_grader_create_test(t,o);$("#notebook_grader_tests_header").show(),$("#notebook_grader_tests_container").append(s)})}function notebook_grader_remove_test(e){const t=_notebook_grader_update_tests_ids(e),o=$("#notebook_grader_tests_container");o.html(""),$.each(t,(e,t)=>{o.append(t)}),0===--notebook_grader_tests_sequence&&$("#notebook_grader_tests_header").hide()}function _notebook_grader_update_tests_ids(e){const t=notebook_grader_tests_sequence,o=[];let _=0,s=0;for(;s<t;s++){if(s===e)continue;const t=[],n=getCurrentNumTestCases(s);for(let e=0;e<n;e++){const o=$(`#notebook_grader_test_${s}_cases_${e}_code`).val(),n=$(`#notebook_grader_test_${s}_cases_${e}_expected_output`).val();t.push(_notebook_grader_get_test_case_element(_,e,o,n))}const a={name:$(`#notebook_grader_test_${s}_name`).val(),weight:$(`#notebook_grader_test_${s}_weight`).val(),custom_feedback:$(`#notebook_grader_test_${s}_custom_feedback`).val(),setup_code:$(`#notebook_grader_test_${s}_setup_code`).val(),show_debug_info:$(`#notebook_grader_test_${s}_show_debug_info`).prop("checked")};o.push(_notebook_grader_get_test_element(_,a,t)),_++}return o}function _notebook_grader_load_test_case_in_modal(e){modal_element.find("#notebook_grader_test_cases_container").append(e),$("#notebook_grader_test_cases_header").show(),$(`#${e.attr("id")} .notebook_code`).each(function(e,t){registerCodeEditor(t,$(t).attr("data-x-language"),$(t).attr("data-x-lines"))})}function notebook_grader_on_edit_test(e){editing_test_id=e;const t={name:$(`#notebook_grader_test_${e}_name`).val(),weight:$(`#notebook_grader_test_${e}_weight`).val(),custom_feedback:$(`#notebook_grader_test_${e}_custom_feedback`).val(),setup_code:$(`#notebook_grader_test_${e}_setup_code`).val()};$("#notebook_grader_test_name").val(t.name),$("#notebook_grader_test_weight").val(t.weight),$("#notebook_grader_test_custom_feedback").val(t.custom_feedback),codeEditors.notebook_grader_test_setup_code.getDoc().setValue(t.setup_code);const o=_notebook_grader_get_test_cases_from_container(e,`notebook_grader_test_${e}`);$.each(o,(e,t)=>{_notebook_grader_load_test_case_in_modal(t)}),modal_element.modal("show")}function notebook_grader_update_test(){const e={name:$("#notebook_grader_test_name").val(),weight:$("#notebook_grader_test_weight").val(),custom_feedback:$("#notebook_grader_test_custom_feedback").val(),setup_code:$("#notebook_grader_test_setup_code").val()};if(!e.name){return toggle_test_case_form_alert(!0,"Please complete all mandatory fields."),void setTimeout(()=>{toggle_test_case_form_alert(!1,"")},6e4)}const t=editing_test_id,o=e.name,_=e.weight,s=e.setup_code,n=e.custom_feedback,a=_notebook_grader_get_test_cases_from_container(t,"notebook_grader_test_cases_container");if(!o||!_||!a.length)return;const r=$(`#notebook_grader_test_${t}`);r.find(`#notebook_grader_test_${t}_name`).val(o),r.find(`#notebook_grader_test_${t}_weight`).val(_),r.find(`#notebook_grader_test_${t}_custom_feedback`).text(n),r.find(`#notebook_grader_test_${t}_setup_code`).text(s),r.find(`#notebook_grader_test_${t}_cases_container`).html(""),$.each(a,(e,o)=>{let _=r.find(`#notebook_grader_test_${t}_cases_container`);_deleteCodeMirror(o),_.append(o)}),modal_element.modal("hide"),editing_test_id=null}function _clear_modal(){$("#notebook_grader_test_form_modal input").val(""),$("#notebook_grader_test_form_modal textarea").val(""),$("#notebook_grader_test_cases_header").hide(),$("#notebook_grader_test_cases_container").html("");$("#notebook_grader_test_form_modal .CodeMirror").each(function(e,t){t.CodeMirror.getDoc().setValue("")})}function _deleteCodeMirror(e){const t=e.attr("id");e.find(".CodeMirror").remove(),delete codeEditors[$(`#${t}_code`).attr("name")]}$(".notebook_grader_submit_test_form").click(e=>{e.preventDefault(),null!==editing_test_id?notebook_grader_update_test():(notebook_grader_add_test_from_form(),updateMainShowDiffsCheckbox())}),modal_element.on("hidden.bs.modal",()=>{null!==editing_test_id&&notebook_grader_update_test(),_clear_modal()}),modal_element.on("shown.bs.modal",()=>{$("#notebook_grader_test_form_modal .CodeMirror").each(function(e,t){t.CodeMirror.refresh()})});