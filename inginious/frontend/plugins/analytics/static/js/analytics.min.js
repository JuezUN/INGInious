function get_service_name_by_key(t){return all_services[t]}function get_services_names(t=[]){return t.map(t=>get_service_name_by_key(t))}function generate_get_url_plot(t){const e=[t],a=[],n=$("#analytics_username").val(),r=$("#analytics_date").val(),s=$("#analytics_service").val();return(n||r||s)&&e.push("?"),n&&a.push("username="+n),s&&a.push("service="+s),r&&a.push("start_date="+r),e.push(a.join("&")),e.join("")}function on_search(){$('.active > a[data-toggle="tab"]').trigger("shown.bs.tab")}function parse_str_to_date(t){return new Date(t)}const AnalyticsDiagram=function(){function t(){this._cachedPromise=null}return t.prototype.plot=function(){this._plotData()},t.prototype._plotData=function(){throw"Not implemented"},t}();$(function(){const t={"heat-map-tab":new HeatMap,"plot-visits-per-day-tab":new VisitsPerDayChart,"box-plot-tab":new BoxPlot,"radar-plot-tab":new RadarPlot};$('a[data-toggle="tab"]').on("shown.bs.tab",function(e){const a=t[e.target.id];a&&a.plot()}),$('.active > a[data-toggle="tab"]').trigger("shown.bs.tab"),$("#analytics_date_filter").datetimepicker({locale:"en",sideBySide:!0,maxDate:moment(),format:"YYYY-MM-DD"}),$("#analytics_date").val(`${(new Date).getFullYear()}-01-01`),$("#analytics_service").val("")});const BoxPlot=function(){function t(){this.div_id="analytics_box_plot",this.request_url="/api/analytics/"}return t.prototype=Object.create(AnalyticsDiagram.prototype),t.prototype._parse_date=function(t){const e=new Date(t);return e.setHours(0),e.setMinutes(0),e.setSeconds(0),e.setMilliseconds(0),e.toISOString()},t.prototype._get_visits_by_service=function(t){const e={};return t.forEach((t,a)=>{const n=this._parse_date(t.date);t.service in e||(e[t.service]={}),n in e[t.service]||(e[t.service][n]=0),e[t.service][n]+=1}),e},t.prototype._get_all_dates=function(t){const e={};return t.forEach((t,a)=>{const n=this._parse_date(t.date);e[n]=0}),Object.keys(e)},t.prototype._generate_plot_layout=function(){return{title:"Box plot of used services",yaxis:{autorange:!0,showgrid:!0,zeroline:!0,dtick:5,gridcolor:"rgb(255, 255, 255)",gridwidth:1,zerolinecolor:"rgb(255, 255, 255)",zerolinewidth:2},margin:{l:40,r:30,b:80,t:100},paper_bgcolor:"rgb(243, 243, 243)",plot_bgcolor:"rgb(243, 243, 243)",showlegend:!1}},t.prototype._plotData=function(){const t=this;Plotly.d3.json(generate_get_url_plot(t.request_url),function(e,a){const n=t._get_visits_by_service(a),r=t._get_all_dates(a),s=Object.keys(n),i=[];s.forEach((t,e)=>{const a=[];r.forEach((e,r)=>{e in n[t]?a.push(n[t][e]):a.push(0)}),i.push(a)});const o=[];for(let t=0;t<s.length;t++){const e={type:"box",y:i[t],name:get_service_name_by_key(s[t]),jitter:.5,whiskerwidth:.2,fillcolor:"cls",marker:{size:2},line:{width:1}};o.push(e)}const l=t._generate_plot_layout();Plotly.newPlot(t.div_id,o,l,{showSendToCloud:!0})})},t}(),HeatMap=function(){function t(){this.div_id="analytics_heat_map_calendar",this._calendar_request="/api/analytics/",this.color=d3.scale.linear().range(["#ebedf0","#e2e45b","#196127"]).domain([0,.5,1]),this.width=900,this.height=105,this.cellSize=12,this.week_days=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],this.month=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],this.day=d3.time.format("%w"),this.week=d3.time.format("%U"),this.percent=d3.format(".1%"),this.format=d3.time.format("%Y%m%d"),this.start_year=(new Date).getFullYear()}return t.prototype=Object.create(AnalyticsDiagram.prototype),t.prototype.update_year=function(){this.start_year=Number(parse_str_to_date(document.getElementById("analytics_date").value).getFullYear())-1,this.start_year||(this.start_year=(new Date).getFullYear()-1)},t.prototype._get_svg=function(){const t=this;const e=d3.select("#"+this.div_id).selectAll("svg").data(d3.range((new Date).getFullYear(),this.start_year,-1)).enter().append("svg").attr("width","100%").attr("data-height","0.5678").attr("viewBox","0 0 900 105").attr("class","RdYlGn").append("g").attr("transform","translate("+(this.width-53*this.cellSize)/2+","+(this.height-7*this.cellSize-1)+")");e.append("text").attr("transform","translate(-38,"+3.5*this.cellSize+")rotate(-90)").style("text-anchor","middle").text(function(t){return t});for(let a=0;a<7;a++)e.append("text").attr("transform","translate(-5,"+this.cellSize*(a+1)+")").style("text-anchor","end").attr("dy","-.25em").text(function(e){return t.week_days[a]});return e.selectAll(".month").data(function(t){return d3.time.months(new Date(t,0,1),new Date(t+1,0,1))}).enter().append("path").attr("class","month").attr("id",function(e,a){return t.month[a]}).attr("d",function(e){const a=new Date(e.getFullYear(),e.getMonth()+1,0),n=+t.day(e),r=+t.week(e),s=+t.day(a),i=+t.week(a);return"M"+(r+1)*t.cellSize+","+n*t.cellSize+"H"+r*t.cellSize+"V"+7*t.cellSize+"H"+i*t.cellSize+"V"+(s+1)*t.cellSize+"H"+(i+1)*t.cellSize+"V0H"+(r+1)*t.cellSize+"Z"}),e.selectAll(".legend").data(t.month).enter().append("g").attr("class","legend").attr("transform",function(t,e){return"translate("+(50*(e+1)+8)+",0)"}).append("text").attr("class",function(e,a){return t.month[a]}).style("text-anchor","end").attr("dy","-.25em").text(function(e,a){return t.month[a]}),e},t.prototype._get_rect=function(){const t=this;return this.update_year(),this._get_svg().selectAll(".day").data(function(t){return d3.time.days(new Date(t,0,1),new Date(t+1,0,1))}).enter().append("rect").attr("class","day").attr("width",this.cellSize).attr("height",this.cellSize).attr("x",function(e){return t.week(e)*t.cellSize}).attr("y",function(e){return t.day(e)*t.cellSize}).attr("fill","#fff").attr("onclick",function(e){return"console.log("+t.week(e)+");"}).datum(this.format)},t.prototype._plotData=function(){const t=this;$("#"+this.div_id).html(""),d3.json(generate_get_url_plot(t._calendar_request),function(e,a){const n={},r={};a.forEach(function(t,e){let a=new Date(t.date);a.setHours(0),a.setMinutes(0),a.setSeconds(0),(a=a.toISOString().slice(0,10))in n?n[a]+=1:(n[a]=1,r[a]=[]),r[a].push(t)});let s=new Date;s.setDate(s.getDate()+1);let i=new Date;i.setFullYear(t.start_year),i.setMonth(0),i.setDate(0),s=s.toISOString().slice(0,10);let o=i.toISOString().slice(0,10);const l=[];for(;o!==s;)o in n?l.push({date:o.replace(/\-/g,""),visits:n[o]}):l.push({date:o.replace(/\-/g,""),visits:0}),(o=new Date(o)).setDate(o.getDate()+1),o=o.toISOString().slice(0,10);const c=d3.max(l,function(t){return t.visits}),u=d3.nest().key(function(t){return t.date}).rollup(function(t){return Math.sqrt(c>0?t[0].visits/c:0)}).map(l);t._get_rect().filter(function(t){return t in u}).attr("fill",function(e){return t.color(u[e])}).attr("data-title",function(t){return t.slice(0,4)+"-"+t.slice(4,6)+"-"+t.slice(6,8)+" visits : "+(n[t.slice(0,4)+"-"+t.slice(4,6)+"-"+t.slice(6,8)]?n[t.slice(0,4)+"-"+t.slice(4,6)+"-"+t.slice(6,8)]:0)}),$("rect").tooltip({container:"body",html:!0,placement:"top"})})},t}(),RadarPlot=function(){function t(){this.div_id="analytics_radar_plot",this._radar_request="/api/analytics/"}return t.prototype=Object.create(AnalyticsDiagram.prototype),t.prototype._plotData=function(){const t=this;Plotly.d3.json(generate_get_url_plot(t._radar_request),function(e,a){const n={};a.forEach((t,e)=>{t.service in n?n[t.service]+=1:n[t.service]=1});const r=Object.keys(n),s=r.map(t=>n[t]);r.push(r[0]),s.push(s[0]);const i=[{type:"scatterpolar",r:s,theta:get_services_names(r),fill:"toself",name:"Group A"}],o={polar:{radialaxis:{visible:!0,range:[0,Math.max.apply(this,s)]}}};Plotly.newPlot(t.div_id,i,o,{showSendToCloud:!0})})},t}(),VisitsPerDayChart=function(){function t(){this.div_id="analytics_plot_visits_per_day",this._time_series_request="/api/analytics/"}return t.prototype=Object.create(AnalyticsDiagram.prototype),t.prototype._parse_time_series_data=function(t){const e={};return t.forEach((t,a)=>{const n=new Date(t.date);n.setHours(0),n.setMinutes(0),n.setSeconds(0),n.setMilliseconds(0);const r=n.toISOString();r in e||(e[r]={}),t.service in e[r]?e[r][t.service]+=1:e[r][t.service]=1}),e},t.prototype._get_data_by_service=function(t){const e={};return Object.keys(t).sort().forEach((a,n)=>{for(let n in t[a])n in e||(e[n]=[]),e[n].push({date:a.slice(0,10),visits:t[a][n]})}),e},t.prototype._get_data_by_day=function(t){const e=[];return Object.keys(t).sort().forEach((a,n)=>{let r=0;for(let e in t[a])r+=t[a][e];const s={date:a.slice(0,10),visits:r};e.push(s)}),e},t.prototype._generate_traces=function(t,e){const a={type:"scatter",mode:"lines",name:"All",x:unpack(t,"date"),y:unpack(t,"visits"),line:{color:"#17BECF"}},n={},r=d3.scale.linear().domain([0,.5,1]).range(["red","yellow","green"]);let s=Object.keys(e).length;Object.keys(e).forEach((t,a)=>{n[t]={type:"scatter",mode:"lines",name:get_service_name_by_key(t),x:unpack(e[t],"date"),y:unpack(e[t],"visits"),line:{color:r(a*(1/(s-1)))}}});const i=[a];for(let t in n)i.push(n[t]);return i},t.prototype._plotData=function(){const t=this;Plotly.d3.json(generate_get_url_plot(t._time_series_request),function(e,a){const n=t._parse_time_series_data(a),r=t._get_data_by_day(n),s=t._get_data_by_service(n),i=t._generate_traces(r,s),o=new Date,l=new Date(o.getFullYear(),0,1),c=new Date(o);c.setMonth(c.getMonth()-2);let u={title:"Visits per day",xaxis:{range:[c.toISOString().slice(0,10),(new Date).toISOString().slice(0,10)],rangeselector:{buttons:[{count:1,label:"1 month",step:"month",stepmode:"backward"},{count:6,label:"6 months",step:"month",stepmode:"backward"},{step:"all"}]},rangeslider:{range:[l,(new Date).toISOString().slice(0,10)]},type:"date"},yaxis:{autorange:!0,type:"linear"}};Plotly.newPlot(t.div_id,i,u,{showSendToCloud:!0})})},t}();function unpack(t,e){return t.map(function(t){return t[e]})}