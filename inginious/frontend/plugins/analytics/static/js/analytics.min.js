function get_service_name_by_key(t){return all_services[t]}function get_services_names(t=[]){return t.map(t=>get_service_name_by_key(t))}function getCourseNameByKey(t){return all_courses[t]}function getCoursesNames(t=[]){return t.map(t=>getCourseNameByKey(t))}function generate_get_url_plot(t){const e=[t],a=[],n=$("#analytics_username").val(),r=$("#analytics_from_date").val(),o=$("#analytics_to_date").val(),i=$("#analytics_service").val(),l=$("#analytics_course").val();return(n||r||o||i||l)&&e.push("?"),n&&a.push("username="+n),i&&a.push("service="+i),r&&a.push("start_date="+r),o&&a.push("end_date="+o),l&&a.push("course_id="+l),e.push(a.join("&")),e.join("")}function updateDataFilters(){$('.active > a[data-toggle="tab"]').trigger("shown.bs.tab")}function parse_str_to_date(t){return new Date(t)}const AnalyticsDiagram=function(){function t(){this._cachedPromise=null}return t.prototype.plot=function(){this._plotData()},t.prototype._plotData=function(){throw"Not implemented"},t}();function getAllAnalytics(){return $.get(generate_get_url_plot("/api/analytics/"),function(t){exportCSVFile(t,"analytics")},"json").fail(function(){})}function exportCSVFile(t,e){const a=`${e}.csv`,n="data:text/csv;charset=utf-8,"+Papa.unparse(t),r=encodeURI(n),o=document.createElement("a");o.setAttribute("href",r),o.setAttribute("download",a),document.body.appendChild(o),o.click(),o.remove()}function turnStringNumberToTwoDigitFormat(t){return t.toString().padStart(2,"0")}function setupDatetimePicker(){const t=$("#analytics_from_date_filter"),e=$("#analytics_to_date_filter");t.datetimepicker({locale:"en",sideBySide:!0,maxDate:moment(),format:"YYYY-MM-DD"}),e.datetimepicker({locale:"en",sideBySide:!0,maxDate:moment(),format:"YYYY-MM-DD"}),t.on("dp.change",function(){const t=$("#analytics_from_date").val();e.data("DateTimePicker").minDate(t)}),updateDate()}function updateDate(){const t=new Date,e=$("#analytics_from_date");e.val(`${t.getFullYear()}-01-02`),e.trigger("dp.change"),$("#analytics_to_date").val(`${t.getFullYear()}-${turnStringNumberToTwoDigitFormat(t.getMonth()+1)}-${turnStringNumberToTwoDigitFormat(t.getDate())}`)}function setupServiceAndCourseFilter(){const t=$("#analytics_course"),e=$("#analytics_service");function a(t,e){$(`#${t} [class="ms-select-all"] span`).html(`[${e}]`)}t.multipleSelect({maxHeight:140,onClick:function(t){t.selected||a("courseCol","Select all")},onCheckAll:function(){a("courseCol","Deselect all")},onUncheckAll:function(){a("courseCol","Select all")},onAfterCreate:function(){t.multipleSelect("uncheckAll")}}),e.multipleSelect({maxHeight:140,onClick:function(t){t.selected||a("serviceCol","Select all")},onCheckAll:function(){a("serviceCol","Deselect all")},onUncheckAll:function(){a("serviceCol","Select all")},onAfterCreate:function(){e.multipleSelect("uncheckAll")}})}function setupTabs(){const t={"heat-map-tab":new HeatMap,"plot-visits-per-day-tab":new VisitsPerDayChart,"box-plot-tab":new BoxPlot,"radar-plot-tab":new RadarPlot,"bar-plot-tab":new StackedBarPlot};$('a[data-toggle="tab"]').on("shown.bs.tab",function(e){const a=t[e.target.id];a&&a.plot()})}$(function(){setupTabs(),setupDatetimePicker(),setupServiceAndCourseFilter(),updateDataFilters()});const BoxPlot=function(){function t(){this.div_id="analytics_box_plot",this.request_url="/api/box_plot_analytics/"}return t.prototype=Object.create(AnalyticsDiagram.prototype),t.prototype._generatePlotLayout=function(){return{title:"Box plot of used services",yaxis:{autorange:!0,showgrid:!0,zeroline:!0,tickmode:"auto",gridcolor:"rgb(255, 255, 255)",gridwidth:1,zerolinecolor:"rgb(255, 255, 255)",zerolinewidth:2},margin:{l:40,r:30,b:80,t:100},paper_bgcolor:"rgb(243, 243, 243)",plot_bgcolor:"rgb(243, 243, 243)",showlegend:!1}},t.prototype._plotData=function(){const t=this;Plotly.d3.json(generate_get_url_plot(t.request_url),function(e,a){const n=a.x_data,r=a.y_data,o=[];for(let t=0;t<n.length;t++){const e={type:"box",y:r[t],name:get_service_name_by_key(n[t]),jitter:.5,whiskerwidth:.2,fillcolor:"cls",marker:{size:2},line:{width:1}};o.push(e)}const i=t._generatePlotLayout();Plotly.newPlot(t.div_id,o,i,{showSendToCloud:!0})})},t}(),HeatMap=function(){function t(){this.div_id="analytics_heat_map_calendar",this._calendar_request="/api/calendar_plot_analytics/",this.color=d3.scale.linear().range(["#ebedf0","#e2e45b","#196127"]).domain([0,.5,1]),this.width=900,this.height=105,this.cellSize=12,this.week_days=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],this.month=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],this.day=d3.time.format("%w"),this.week=d3.time.format("%U"),this.percent=d3.format(".1%"),this.format=d3.time.format("%Y%m%d"),this.start_year=(new Date).getFullYear()}return t.prototype=Object.create(AnalyticsDiagram.prototype),t.prototype.update_year=function(){this.start_year=Number(parse_str_to_date($("#analytics_date").val()).getFullYear())-1,this.start_year||(this.start_year=(new Date).getFullYear()-1)},t.prototype._get_svg=function(){const t=this;const e=d3.select("#"+this.div_id).selectAll("svg").data(d3.range((new Date).getFullYear(),this.start_year,-1)).enter().append("svg").attr("width","100%").attr("data-height","0.5678").attr("viewBox","0 0 900 105").attr("class","RdYlGn").append("g").attr("transform","translate("+(this.width-53*this.cellSize)/2+","+(this.height-7*this.cellSize-1)+")");e.append("text").attr("transform","translate(-38,"+3.5*this.cellSize+")rotate(-90)").style("text-anchor","middle").text(function(t){return t});for(let a=0;a<7;a++)e.append("text").attr("transform","translate(-5,"+this.cellSize*(a+1)+")").style("text-anchor","end").attr("dy","-.25em").text(function(e){return t.week_days[a]});return e.selectAll(".month").data(function(t){return d3.time.months(new Date(t,0,1),new Date(t+1,0,1))}).enter().append("path").attr("class","month").attr("id",function(e,a){return t.month[a]}).attr("d",function(e){const a=new Date(e.getFullYear(),e.getMonth()+1,0),n=+t.day(e),r=+t.week(e),o=+t.day(a),i=+t.week(a);return"M"+(r+1)*t.cellSize+","+n*t.cellSize+"H"+r*t.cellSize+"V"+7*t.cellSize+"H"+i*t.cellSize+"V"+(o+1)*t.cellSize+"H"+(i+1)*t.cellSize+"V0H"+(r+1)*t.cellSize+"Z"}),e.selectAll(".legend").data(t.month).enter().append("g").attr("class","legend").attr("transform",function(t,e){return"translate("+(50*(e+1)+8)+",0)"}).append("text").attr("class",function(e,a){return t.month[a]}).style("text-anchor","end").attr("dy","-.25em").text(function(e,a){return t.month[a]}),e},t.prototype._get_rect=function(){const t=this;return this.update_year(),this._get_svg().selectAll(".day").data(function(t){return d3.time.days(new Date(t,0,1),new Date(t+1,0,1))}).enter().append("rect").attr("class","day").attr("width",this.cellSize).attr("height",this.cellSize).attr("x",function(e){return t.week(e)*t.cellSize}).attr("y",function(e){return t.day(e)*t.cellSize}).attr("fill","#fff").attr("onclick",function(e){return"console.log("+t.week(e)+");"}).datum(this.format)},t.prototype._plotData=function(){const t=this;$("#"+this.div_id).html(""),d3.json(generate_get_url_plot(t._calendar_request),function(e,a){let n=new Date;n.setDate(n.getDate()+1);let r=new Date;r.setFullYear(t.start_year),r.setMonth(0),r.setDate(0),n=n.toISOString().slice(0,10);let o=r.toISOString().slice(0,10);const i=[];for(;o!==n;)o in a?i.push({date:o.replace(/\-/g,""),visits:a[o]}):i.push({date:o.replace(/\-/g,""),visits:0}),(o=new Date(o)).setDate(o.getDate()+1),o=o.toISOString().slice(0,10);const l=d3.max(i,function(t){return t.visits}),s=d3.nest().key(function(t){return t.date}).rollup(function(t){return Math.sqrt(l>0?t[0].visits/l:0)}).map(i);t._get_rect().filter(function(t){return t in s}).attr("fill",function(e){return t.color(s[e])}).attr("data-title",function(t){return t.slice(0,4)+"-"+t.slice(4,6)+"-"+t.slice(6,8)+" visits : "+(a[t.slice(0,4)+"-"+t.slice(4,6)+"-"+t.slice(6,8)]?a[t.slice(0,4)+"-"+t.slice(4,6)+"-"+t.slice(6,8)]:0)}),$("rect").tooltip({container:"body",html:!0,placement:"top"})})},t}(),RadarPlot=function(){function t(){this.div_id="analytics_radar_plot",this._radar_request="/api/radar_plot_analytics/"}return t.prototype=Object.create(AnalyticsDiagram.prototype),t.prototype._plotData=function(){const t=this;Plotly.d3.json(generate_get_url_plot(t._radar_request),function(e,a){const n=a.services,r=a.visits;n.push(n[0]),r.push(r[0]);const o=[{type:"scatterpolar",r:r,theta:get_services_names(n),fill:"toself",name:"Group A"}],i={polar:{radialaxis:{visible:!0,range:[0,Math.max.apply(this,r)]}}};Plotly.newPlot(t.div_id,o,i,{showSendToCloud:!0})})},t}(),VisitsPerDayChart=function(){function t(){this.div_id="analytics_plot_visits_per_day",this._time_series_request="/api/time_series_plot_analytics/"}return t.prototype=Object.create(AnalyticsDiagram.prototype),t.prototype._generate_traces=function(t,e){const a={type:"scatter",mode:"lines",name:"All",x:t.dates,y:t.counts,line:{color:"#17BECF"}},n={},r=d3.scale.linear().domain([0,.5,1]).range(["red","yellow","green"]);let o=Object.keys(e).length;Object.keys(e).forEach((t,a)=>{n[t]={type:"scatter",mode:"lines",name:get_service_name_by_key(t),x:unpack(e[t],"date"),y:unpack(e[t],"visits"),line:{color:r(a*(1/(o-1)))}}});const i=[a];for(let t in n)i.push(n[t]);return i},t.prototype._plotData=function(){const t=this;Plotly.d3.json(generate_get_url_plot(t._time_series_request),function(e,a){const n=a.data_all_services,r=a.data_by_service,o=t._generate_traces(n,r),i=new Date,l=new Date(i.getFullYear(),0,1),s=new Date(i);s.setMonth(s.getMonth()-2);let c={title:"Visits per day",xaxis:{autorange:!0,range:[s.toISOString().slice(0,10),(new Date).toISOString().slice(0,10)],rangeselector:{buttons:[{count:1,label:"1 month",step:"month",stepmode:"backward"},{count:6,label:"6 months",step:"month",stepmode:"backward"},{step:"all"}]},rangeslider:{range:[l,(new Date).toISOString().slice(0,10)]},type:"date"},yaxis:{autorange:!0,type:"linear"}};Plotly.newPlot(t.div_id,o,c,{showSendToCloud:!0})})},t}();function unpack(t,e){return t.map(function(t){return t[e]})}const StackedBarPlot=function(){function t(){this.divId="analyticsPerCoursePlot",this.requestUrl="/api/stacked_bar_plot_analytics/"}return t.prototype=Object.create(AnalyticsDiagram.prototype),t.prototype._generate_plot_layout=function(t){return{barmode:"stack",annotations:t,showlegend:!0,plot_bgcolor:"#F3F3F3",paper_bgcolor:"#F3F3F3"}},t.prototype._generateTraces=function(t,e,a){let n=[];const r=d3.scale.linear().domain([0,.5,1]).range(["red","yellow","green"]);return $.each(a,function(o,i){const l=r(o*(1/a.length)),s=function(t,e,a,n){return{x:t,y:e,name:a,type:"bar",marker:{color:n}}}(t,e[o],i,l);n.push(s)}),n},t.prototype._plotData=function(){const t=this;Plotly.d3.json(generate_get_url_plot(t.requestUrl),function(e,a){const n=getCoursesNames(a.x_data),r=0!==(o=a.y_data).length?o[0].map((t,e)=>o.map(t=>t[e])):[];var o;const i=get_services_names(a.services),l=t._generateTraces(n,r,i),s=function(t,e){const a=[],n=e.map(t=>t.reduce((t,e)=>t+e,0));return $.each(t,(t,e)=>{a.push(function(t,e){return{x:t,y:e,text:e,xanchor:"center",yanchor:"bottom",showarrow:!1}}(e,n[t]))}),a}(n,a.y_data),c=t._generate_plot_layout(s);Plotly.newPlot(t.divId,l,c)})},t}();