const USER_INFORMATION_TABLE_ID="userInformation",USER_TOTAL_TABLE_ID="userInformationFoot",USER_COURSES_TABLE_ID="userCoursesInformation",USER_INFORMATION_TITLE_ID="userInformationTitle";function requestUserData(e,t){function n(e,t){$(`#${e}`).val(t)}$.get("/api/user_management",{username:e,email:t},function(e){resetElements(),getCurrentValues(e),updateSubmissionStatus(),timeInterval=openTimeInterval(),showUserSettings(),n(NEW_USERNAME_INPUT_ID,currentUsername),n(NEW_NAME_INPUT_ID,currentName),n(NEW_EMAIL_INPUT_ID,currentEmail),fillUserTable(user_info_table=1,data_dict=e.count),fillUserTable(user_info_table=0,data_dict=e.courses),alertForUnknownCollections(e.unknown_collections),fillUserInformationTitle(e)})}function showUserSettings(){$(`#${USER_SETTINGS_ID}`).show()}function hideUserSettingsDiv(){$(`#${USER_SETTINGS_ID}`).hide()}function getCurrentValues(e){currentEmail=e.email,currentName=e.name,currentUsername=e.username,currentCollectionList=Object.keys(Object.fromEntries(Object.entries(e.count).filter(([e,t])=>t>0)))}function fillUserTable(e=1,t){function n(e,t,n=!1){return n?`<tr><td><h5><b>${e}</b></h5></td><td><h5><b>${t}</b></h5></td></tr>`:`<tr><td><h5><b>${e}</b></h5></td><td><h5>${t}</h5></td></tr>`}if(e){let e=0;for(const[r,a]of Object.entries(t))e+=a,$(`#${USER_INFORMATION_TABLE_ID}`).append(n(r,a));$(`#${USER_TOTAL_TABLE_ID}`).append(n("Total",e,!0))}else for(const[e,r]of Object.entries(t))$(`#${USER_COURSES_TABLE_ID}`).append(n(e,r))}function allowEdit(){$(".edit").on("click",function(){const e=$(this).attr("data-action"),t=$(e),n=t.prop("readonly");t.prop("readonly",!n),n&&t.trigger("focus")})}function checkEmailFormat(e){return/^[^@]+@[^@]+\.[A-Z0-9._-]/i.test(e)}function checkEmailInput(){const e=$(`#${NEW_EMAIL_INPUT_ID}`);if(removeErrorStyle(e),hasEmailChanged())return!!checkEmailFormat(e.val())||(addErrorStyle(e,emailFormatError),!1)}function checkUsernameFormat(e){return/^[-_.|~0-9A-Z]{4,}$/i.test(e)}function checkUsername(){const e=$(`#${NEW_USERNAME_INPUT_ID}`);return removeErrorStyle(e),!!hasUsernameChanged()&&(checkTextLen(e.val(),4)?!!checkUsernameFormat(e.val())||(addErrorStyle(e,usernameFormatError),!1):(addErrorStyle(e,inputLenError),!1))}function checkName(){const e=$(`#${NEW_NAME_INPUT_ID}`);return removeErrorStyle(e),!!hasNameChanged()&&(!!checkTextLen(e.val(),1)||(addErrorStyle(e,inputLenError),!1))}function hasUsernameChanged(){return $(`#${NEW_USERNAME_INPUT_ID}`).val()!==currentUsername}function hasNameChanged(){return $(`#${NEW_NAME_INPUT_ID}`).val()!==currentName}function hasEmailChanged(){return $(`#${NEW_EMAIL_INPUT_ID}`).val()!==currentEmail}function getInputValue(e){return $(`#${e}`).val()}function cleanUserInfoTable(){$(`#${USER_INFORMATION_TABLE_ID}`).empty(),$(`#${USER_TOTAL_TABLE_ID}`).empty()}function cleanUserCoursesTable(){$(`#${USER_COURSES_TABLE_ID}`).empty()}function alertForUnknownCollections(e){e.length&&new MessageBox(NOTIFICATIONS_ID,`${unknownCollectionsMessage}: ${e}. ${pleaseCheck}`,"warning",!1)}function fillUserInformationTitle(e){const t=e.username,n=e.name;$(`#${USER_INFORMATION_TITLE_ID}`).html(`${userInformationTitleText}: ${t} (${n})`)}function disableSettings(e){$(`#${UPDATE_BTN_ID}`).prop("disabled",e),$(".edit").each(function(t,n){const r=$(n).attr("data-action"),a=$(r);e?(a.prop("readonly",e),$(n).html(`<i class="fa fa-pencil" aria-hidden="true"></i>${editText}</a></td>`),$(n).addClass("disabled")):$(n).removeClass("disabled")})}const USER_LIST_DIV_ID="listOfUsers",USER_LIST_TABLE_ID="userList",FIELD_OPTION_ID="fieldOption",SEARCH_BTN_ID="searchBtn",USER_BASIC_DATA_INPUT_ID="userBasicDataInput";function addSearchBtnListener(){$(`#${SEARCH_BTN_ID}`).on("click",function(){if(checkSearchInput()){const e=$(`#${FIELD_OPTION_ID}`).val(),t=getSearchParameter();$.get("/api/find_user",{user:t,field:e},function(e){resetElements(),_updateUserTable(e)})}else new MessageBox(NOTIFICATIONS_ID,inputGeneralError,"danger",!1)})}function addSearchInputEnterListener(){$(`#${USER_BASIC_DATA_INPUT_ID}`).on("keypress",function(e){"Enter"===e.key&&(e.preventDefault(),$(`#${SEARCH_BTN_ID}`).trigger("click"))})}function configUserTable(){cleanUserListTable(),hideUserListTableDiv()}function showUserListTableDiv(){$(`#${USER_LIST_DIV_ID}`).show()}function hideUserListTableDiv(){$(`#${USER_LIST_DIV_ID}`).hide()}function _updateUserTable(e){const t=e.users;configUserTable(),t.length?_appendUsersToTable(t):_appendNoUserMessage(),showUserListTableDiv()}function cleanUserListTable(){$(`#${USER_LIST_TABLE_ID}`).empty()}function _appendUsersToTable(e){const t=$(`#${USER_LIST_TABLE_ID}`);$.each(e,(e,n)=>{t.append(_createUserItem(n))})}function _createUserItem(e){const t=e.username,n=e.email;return`<tr class="itemSelection" onclick='requestUserData("${t}","${n}")'><td>${t}</td><td>${n}</td><td>${e.realname}</td></tr>`}function _appendNoUserMessage(){const e=`<tr><td colspan="3" class="text-center"><h4>${noUser}</h4></td></tr>`;$(`#${USER_LIST_TABLE_ID}`).append(e)}function checkSearchInput(){const e=$(`#${USER_BASIC_DATA_INPUT_ID}`);return removeErrorStyle(e),!!checkTextLen(e.val(),4)||(addErrorStyle(e,inputLenError),!1)}function getSearchParameter(){return $(`#${USER_BASIC_DATA_INPUT_ID}`).val()}const UPDATE_BTN_ID="updateBtn",UPDATE_CONFIRM_ID="updateDataConfirmBtn",MODAL_ID="uploadModal",PARAMETERS_LIST_ID="listParametersChanged",USERNAME_TEXT_ID="usernameToConfirm",CONFIRMATION_INPUT_ID="usernameInputConfirmation";let requestToUpdate={};function addListenerUpdateBtn(){$(`#${UPDATE_BTN_ID}`).off("click").on("click",function(){var e;requestToUpdate=validateInputs(),e=requestToUpdate,0!==Object.keys(e).length?(configModal(),confirmListener()):(new MessageBox(NOTIFICATIONS_ID,inputGeneralError,"danger",!1),mainScrollToTop())})}function configModal(){$(`#${MODAL_ID}`).modal("show"),$(`#${USERNAME_TEXT_ID}`).html(currentUsername),$(`#${CONFIRMATION_INPUT_ID}`).val("")}function confirmListener(){function e(e){let t="";for(const[n,r]of Object.entries(e))t+=`<li><b>${wordsDictionary[n]}:</b> ${r}</li>`;return`<ul class="normalList">${t}</ul>`}$(`#${UPDATE_CONFIRM_ID}`).off("click").on("click",function(){requestToUpdate.username=currentUsername,checkConfirmationInput()&&(hideModal(),mainScrollToTop(),disableSettings(!0),$.post("/api/user_management",requestToUpdate,function(t){const n=`<strong>${successMessage}:</strong> ${e(t)}`;resetElements(),new MessageBox(NOTIFICATIONS_ID,n,"success",!1)}).fail((t,n,r)=>{const a=JSON.parse(t.responseText),s=`<strong>${errorText}:</strong> ${e(a)}`;new MessageBox(NOTIFICATIONS_ID,s,"danger",!1)}).done(()=>{disableSettings(!1)}))})}function checkConfirmationInput(){const e=$(`#${CONFIRMATION_INPUT_ID}`);return removeErrorStyle(e),e.val()===currentUsername||(addErrorStyle(e,usernameMatchError),!1)}function createListElement(e){return`<li><b>${e}</b></li>`}function addListElement(e){$(`#${PARAMETERS_LIST_ID}`).append(e)}function validateInputs(){return requestToUpdate={},cleanList(),checkUsername()&&(requestToUpdate.new_username=getInputValue(NEW_USERNAME_INPUT_ID),requestToUpdate.collection_list=JSON.stringify(currentCollectionList),addListElement(createListElement(wordsDictionary.username))),checkName()&&(requestToUpdate.name=getInputValue(NEW_NAME_INPUT_ID),addListElement(createListElement(wordsDictionary.name))),checkEmailInput()&&(requestToUpdate.email=getInputValue(NEW_EMAIL_INPUT_ID),addListElement(createListElement(wordsDictionary.email))),requestToUpdate}function cleanList(){$(`#${PARAMETERS_LIST_ID}`).empty()}function hideModal(){$(`#${MODAL_ID}`).modal("hide")}const USER_SESSIONS_BADGE_ID="userConnection",SUBMISSIONS_TABLE_ID="userSubmissions";function updateSubmissionStatus(){$.ajax({data:{username:currentUsername},type:"GET",url:"/api/user_status",success:function(e){_updateSubmissionTable(e),_updateBadge(e.num_connections)},beforeSend(e,t){}})}function _updateSubmissionTable(e){const t=e.submissions,n=e.custom_test;cleanSubmissionsTable(),t.length||n.length?(_appendSubmissionsToTable("Submission",t),_appendSubmissionsToTable("Custom Test",n)):_appendNoSubmissionsMessage()}function _updateBadge(e){const t=$(`#${USER_SESSIONS_BADGE_ID}`);function n(){"label-danger label-success".split(" ").forEach(function(e){t.toggleClass(e)})}t.hasClass("label-success")&&n(),t.text(""),t.text(e),e>0&&n()}function _appendSubmissionsToTable(e,t){const n=$(`#${SUBMISSIONS_TABLE_ID}`);$.each(t,(t,r)=>{n.append(_createSubmissionItem(e,r))})}function _createSubmissionItem(e,t){return`<tr><td>${e}</td><td>${t.courseid}</td><td>${t.taskid}</td><td>${t.submitted_on}</td></tr>`}function _appendNoSubmissionsMessage(){const e=`<tr><td colspan="4" class="text-center"><h4>${noSubmissions}</h4></td></tr>`;$(`#${SUBMISSIONS_TABLE_ID}`).append(e)}function cleanSubmissionsTable(){$(`#${SUBMISSIONS_TABLE_ID}`).empty()}function openTimeInterval(){return setInterval(updateSubmissionStatus,3e3)}function closeTimeInterval(){clearInterval(timeInterval)}const NEW_USERNAME_INPUT_ID="newUsernameInput",NEW_NAME_INPUT_ID="newNameInput",NEW_EMAIL_INPUT_ID="newEmailInput",USER_SETTINGS_ID="userSettings",NOTIFICATIONS_ID="notificationsDiv";let timeInterval,currentEmail="",currentName="",currentUsername="",currentCollectionList=[];function addEvents(){allowEdit(),addSearchBtnListener(),addListenerUpdateBtn(),ajaxSetup(),addSearchInputEnterListener(),toggleEditTextListener()}function ajaxSetup(){$.ajaxSetup({beforeSend:function(){new MessageBox(NOTIFICATIONS_ID,"Loading...","info",!1)},error:function(){mainScrollToTop()}})}function cleanNotifications(){$(`#${NOTIFICATIONS_ID}`).empty()}function resetElements(){cleanBasicDataInputs(),cleanUserInfoTable(),cleanUserCoursesTable(),hideUserSettingsDiv(),cleanCurrentValues(),closeTimeInterval(),cleanNotifications(),configUserTable()}function cleanBasicDataInputs(){$(".edit").each(function(e,t){const n=$($(t).attr("data-action"));$(t).html(`<i class="fa fa-pencil" aria-hidden="true"></i>${editText}</a></td>`),n.prop("readonly",!0),n.attr("value","")})}function cleanCurrentValues(){currentEmail="",currentName="",currentUsername="",currentCollectionList=[]}function removeErrorStyle(e){const t=e.parent();t.removeClass("has-error"),t.find("span").remove()}function checkTextLen(e,t){return e.length>=t}function addErrorStyle(e,t){const n=e.parent();n.addClass("has-error"),n.append(`<span class="help-block">${t}</span>`)}function mainScrollToTop(){$(window).scrollTop(0)}function toggleEditTextListener(){$(".edit").on("click",function(){$(this).html().includes(doneEditingText)?$(this).html(`<i class="fa fa-pencil" aria-hidden="true"></i>${editText}</a></td>`):$(this).html(`<i class="fa fa-floppy-o" aria-hidden="true"></i>${doneEditingText}</a></td>`)})}$(function(){resetElements(),addEvents()});
